CREATE TABLE ChucVu
(
	maCV CHAR(10),
	tenChucVu NVARCHAR2(30),
	PRIMARY KEY (maCV)
);

CREATE TABLE NhanVien
(
  maNV CHAR(10) NOT NULL,
  HoTenNV NVARCHAR2(50) NOT NULL,
  SdtNV VARCHAR(12) NOT NULL,
  DiaChiNV NVARCHAR2(50) NOT NULL,
  maCV CHAR(10) NOT NULL,
  PRIMARY KEY (maNV),
  FOREIGN KEY (maCV) REFERENCES ChucVu(maCV)
);

CREATE TABLE Luong
(
  maNV CHAR(10) NOT NULL,
  LuongCoBan INT NOT NULL,
  PhuCap INT,
  TongLuong AS (LuongCoBan + NVL(PhuCap, 0)),
  PRIMARY KEY (maNV),
  FOREIGN KEY (maNV) REFERENCES NHANVIEN(maNV)
);

CREATE TABLE ChamCong
(
  Id INT GENERATED BY DEFAULT AS IDENTITY 	(START WITH 1 INCREMENT BY 1) PRIMARY KEY,
  maNV CHAR(10) NOT NULL,
  GioVao DATE NOT NULL,
  GioRa DATE,
  FOREIGN KEY (maNV) REFERENCES NHANVIEN(maNV)
);

CREATE TABLE KhachHang
(
  maKH CHAR(10) NOT NULL,
  sdtKH VARCHAR(12) NOT NULL,
  HoTenKH NVARCHAR2(50) NOT NULL,
  EmailKH NVARCHAR2(50) NOT NULL,
  DiaChiKH NVARCHAR2(100) NOT NULL,
  CCCD INT NOT NULL,
  GioiTinh INT NOT NULL,
  PRIMARY KEY (maKH)
);

CREATE TABLE HoaDon
(
  maHD CHAR(10) NOT NULL,
  NgayLapHD DATE NOT NULL,
  TinhTrang NVARCHAR2(30) NOT NULL,
  TongHoaDon INT NOT NULL,
  maKH CHAR(10) NOT NULL,
  maNV CHAR(10) NOT NULL,
  PRIMARY KEY (maHD),
  FOREIGN KEY (maKH) REFERENCES KhachHang(maKH),
  FOREIGN KEY (maNV) REFERENCES NHANVIEN(maNV)
);

CREATE TABLE LoaiPhong
(
  maLoaiPH CHAR(10) NOT NULL,
  TenLoaiPH NVARCHAR2(50) NOT NULL,
  SoKhachToiDa INT NOT NULL,
  PRIMARY KEY (maLoaiPH)
);

CREATE TABLE TrangThaiPH 
(
  maTrangThaiPH INT GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
  trangThai NVARCHAR2(100)
);

CREATE TABLE Phong
(
  maPH CHAR(10) NOT NULL,
  TenPH NVARCHAR2(50) NOT NULL,
  GiaPH INT NOT NULL,
  TienNghiPH NVARCHAR2(100) NOT NULL,
  ThongTinPH NVARCHAR2(100) NOT NULL,
  maLoaiPH CHAR(10) NOT NULL,
  maTrangThai int,
  PRIMARY KEY (maPH),
  FOREIGN KEY (maLoaiPH) REFERENCES LoaiPhong(maLoaiPH),
  FOREIGN KEY (maTrangThai) REFERENCES TrangThaiPH(maTrangThaiPH)
);

CREATE TABLE TinhTrangDatPhong
(
  maTTDP INT GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
  TinhTrang NVARCHAR2(100)
);

CREATE TABLE PhieuDatPhong
(
  maPDP CHAR(10) NOT NULL,
  NgayLapPDP DATE NOT NULL,
  NgayNhanPhong DATE NOT NULL,
  NgayTraPhong DATE NOT NULL,
  TongTien INT NOT NULL,
  maPH CHAR(10) NOT NULL,
  maTTDP INT NOT NULL,
  maKH CHAR(10) NOT NULL,
  PRIMARY KEY (maPDP),
  FOREIGN KEY (maPH) REFERENCES Phong(maPH),
  FOREIGN KEY (maTTDP) REFERENCES TinhTrangDatPhong(maTTDP),
  FOREIGN KEY (maKH) REFERENCES KhachHang(maKH)
);


--- Nh?p d? li?u 

--B?ng ch?c v?
insert into ChucVu values ('GD',N'Giám ??c');
insert into ChucVu values ('TP',N'Tr??ng phòng');
insert into ChucVu values ('NV',N'Nhân viên');

select*from ChucVu
go
--B?ng nhân viên
insert into NHANVIEN values ('1',N'Lê H?u Phúc',N'11211386784',N'123 trung tránh, Nhà bè','GD');
insert into NHANVIEN values ('2',N'V? ??c Nam',N'0367590203',N'T?ng 72, tòa nhà LandMark, qu?n 3','TP');
insert into NHANVIEN values ('3',N'Nguy?n Nh?t Ti?n',N'0836447006',N'T?ng 71, tòa nhà LandMark, qu?n 3','NV');
insert into NHANVIEN values ('4',N'Nguy?n H?u Th?',N'0836447006',N'T?ng 71, tòa nhà LandMark, qu?n 3','NV');

--B?ng l??ng
select *from Luong
go
INSERT INTO Luong  VALUES ('1', 20000000, 5000000); 
INSERT INTO Luong  VALUES ('2', 15000000, 3000000);
INSERT INTO Luong  VALUES ('3', 10000000, 2000000);
INSERT INTO Luong  VALUES ('4',10000000, 2000000); 
--B?ng ch?m công
--INSERT INTO ChamCong (maNV, Ngay, GioVao, GioRa) VALUES
insert into ChamCong (id, manv, ngay, giovao, giora) values (1, 3, '2024-03-07', '12:51', '11:07');
insert into ChamCong (id, manv, ngay, giovao, giora) values (2, 1, '2024-03-06', '14:54', '13:20');
insert into ChamCong (id, manv, ngay, giovao, giora) values (3, 4, '2024-03-09', '14:37', '9:20');
insert into ChamCong (id, manv, ngay, giovao, giora) values (4, 1, '2024-03-05', '9:35', '10:30');
insert into ChamCong (id, manv, ngay, giovao, giora) values (5, 4, '2024-03-03', '14:13', '13:50');
insert into ChamCong (id, manv, ngay, giovao, giora) values (6, 2, '2024-03-07', '9:12', '12:08');


--B?ng lo?i phòng
insert into LoaiPhong values ('VIP',N'Phòng vip', 2);
insert into LoaiPhong values ('PT',N'Phòng th??ng', 4);
insert into LoaiPhong values ('PGD',N'Phòng gia ?ình', 5);

--B?ng tr?ng thái phòng
insert into TrangThaiPH values (N'còn tr?ng');
insert into TrangThaiPH values (N'h?t phòng');
insert into TrangThaiPH values (N'?ang s? d?ng');

--B?ng phòng
insert into Phong values ('P01',N'Phòng 01',300000,N'1 máy l?nh, 1 TV, 2 gi??ng',N'Phòng th??ng giá r?','PT',1);
insert into Phong values ('P02',N'Phòng 02',300000,N'1 máy l?nh, 1 TV',N'Phòng th??ng giá r?','PT',2);
insert into Phong values ('P03',N'Phòng 03',300000,N'1 máy l?nh, 1 TV',N'Phòng th??ng giá r?','PT',3);
insert into Phong values ('P04',N'Phòng 04',1000000,N'1 máy l?nh, 1 TV, 1 t? l?nh, 2 gi??ng ?ôi, b?n t?m sang',N'Phòng vip sang, x?n, m?n','VIP',1);
insert into Phong values ('P05',N'Phòng 05',500000,N'1 máy l?nh, 1 TV, 1 t? l?nh, 3 gi??ng',N'Phòng gia ?ình ti?n l?i thoáng mát','PGD',1);

--B?ng tình tr?ng ??t phòng
insert into TinhTrangDatPhong values (N'?ang ??t');
insert into TinhTrangDatPhong values (N'?ã ??t');
insert into TinhTrangDatPhong values (N'?ã h?y');

--B?ng Khách hàng
insert into KhachHang values ('1', '0968472513', N'Nguy?n V?n A', 'nva@gmail.com', N'123 Hà N?i, Vi?t Nam', 123456789, 1);
insert into KhachHang values ('2', '0928472631', N'Tr?n H?ng N', 'tvb@gmail.com', N'456 H? Chí Minh, Vi?t Nam', 234567891, 0);
insert into KhachHang values ('3', '0948162539', N'Ph?m V?n C', 'pvc@gmail.com', N'789 ?à N?ng, Vi?t Nam', 345678912, 1);
insert into KhachHang values ('4', '0935672541', N'Lê Th? D', 'ltd@gmail.com', N'321 C?n Th?, Vi?t Nam', 456789123, 0);
insert into KhachHang values ('5', '0912475639', N'Hoàng Minh E', 'hme@gmail.com', N'654 Nha Trang, Vi?t Nam', 567891234, 1);

--B?ng hóa ??n
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (1, '3/7/2024', 2, 2, 814587, N'?ã Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (2, '3/2/2024', 3, 3, 666022, N'Ch?a Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (3, '3/6/2024', 4, 4, 747642, N'?ã Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (4, '3/6/2024', 3, 2, 537502, N'?ã Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (5, '3/7/2024', 4, 1, 727889, N'Ch?a Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (6, '3/6/2024', 2, 5, 608759, N'Ch?a Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (7, '3/5/2024', 1, 3, 761846, N'?ã Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (8, '3/4/2024', 3, 2, 821112, N'?ã Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (9, '3/2/2024', 2, 1, 792393, N'Ch?a Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (10, '3/2/2024', 3, 3, 379003, N'Ch?a Thanh Toán');
insert into HoaDon (mahd, ngaylaphd, manv, makh, tonghoadon, tinhtrang) values (11, '3/4/2024', 1, 4, 735329, N'Ch?a Thanh Toán');


--B?ng Phi?u ??t phòng   ?ang l?i 
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (1, '2024-03-03', '2024-03-06','2024-03-08' , 10, 3, 100, 7016917);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (2, '2024-03-02', '2024-03-04','2024-03-05' , 1, 1, 38, 4629365);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (3, '2024-03-05', '2024-03-08','2024-03-09' , 4, 1, 97, 98320638);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (4, '2024-03-03', '2024-03-04','2024-03-09' , 11, 2, 29, 54509846);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (5, '2024-03-04', '2024-03-07','2024-03-08' , 14, 3, 57, 94833275);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (6, '2024-03-05', '2024-03-07','2024-03-12' , 7, 2, 20, 34987740);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (7, '2024-03-03', '2024-03-08','2024-03-11' , 1, 2, 92, 42291968);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (8, '2024-03-05', '2024-03-10','2024-03-11' , 6, 2, 54, 19601297);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (9, '2024-03-01', '2024-03-04','2024-03-08' , 15, 1, 25, 91768199);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (10, '2024-03-04', '2024-03-07','2024-03-10' , 14, 2, 67, 88727745);
insert into PhieuDatPhong (mapdp, ngaylappdp, ngaynhanphong, ngaytraphong, maph, mattdp, makh, tongtien) values (11, '2024-03-05', '2024-03-05','2024-03-09' , 15, 1, 69, 72954958);


-- Vi?t các câu procedure 


---SP1: “C?p nh?t tình tr?ng ??t phòng”
CREATE OR REPLACE PROCEDURE sp_CapNhatTinhTrangDatPhong(
    p_maPDP IN CHAR,
    p_maTTDP IN NUMBER
) AS
BEGIN
    UPDATE ChiTietPDP
    SET maTTDP = p_maTTDP
    WHERE maPDP = p_maPDP;
END;

EXEC sp_CapNhatTinhTrangDatPhong 'PDP06', 3;





---SP2:”C?p nh?t b?ng ch?m công ”
CREATE OR REPLACE PROCEDURE sp_UpdateChamCong(
    p_maNV IN CHAR,
    p_Ngay IN DATE,
    p_GioVao IN TIME,
    p_GioRa IN TIME DEFAULT NULL
) AS
BEGIN
    IF NOT EXISTS (SELECT 1 FROM ChamCong WHERE maNV = p_maNV AND Ngay = p_Ngay) THEN
        INSERT INTO ChamCong (maNV, Ngay, GioVao, GioRa)
        VALUES (p_maNV, p_Ngay, p_GioVao, p_GioRa);
    ELSE
        UPDATE ChamCong
        SET GioVao = p_GioVao, GioRa = p_GioRa
        WHERE maNV = p_maNV AND Ngay = p_Ngay;
    END IF;
END;


EXEC sp_UpdateChamCong ‘1’,’2024-03-07’,’12:00’,’11:00’,



--SP3:”Tìm ki?m phòng theo tình tr?ng”
CREATE OR REPLACE PROCEDURE sp_SearchPhongByStatus(
    p_maTrangThai IN NUMBER
) AS
BEGIN
    SELECT * FROM Phong
    WHERE maTrangThai = p_maTrangThai;
END;



EXEC sp_SearchPhongByStatus N’còn tr?ng’;


--SP4:”Tìm ki?m hóa ??n theo mã khách hàng”
CREATE OR REPLACE PROCEDURE sp_SearchHoaDonTheoKhachHang(
    p_maKH IN CHAR
) AS
BEGIN
    SELECT * FROM HoaDon
    WHERE maKH = p_maKH;
END;

EXEC sp_SearchHoaDonTheoKhachHang ‘4’;



---SP5:’Thêm ch?c v? nhân viên m?i’
CREATE OR REPLACE PROCEDURE sp_AddChucVu(
    p_maCV IN CHAR,
    p_tenChucVu IN NVARCHAR2
) AS
BEGIN
    INSERT INTO ChucVu (maCV, tenChucVu) 
    VALUES (p_maCV, p_tenChucVu);
END;



EXEC sp_AddChucVu 'CV01', N'Giám ??c';


---SP6:’Thêm tr?ng thái phòng m?i’
CREATE OR REPLACE PROCEDURE AddTrangThaiPH(
    p_trangThai IN NVARCHAR2
) AS
BEGIN
    INSERT INTO TrangThaiPH (trangThai) 
    VALUES (p_trangThai);
END;


EXEC AddTrangThaiPH N'S?n Sàng';


----SP7:”C?p nh?t l??ng nhân viên”
CREATE OR REPLACE PROCEDURE UpdateLuongNhanVien(
    p_maNV IN CHAR,
    p_LuongCoBan IN NUMBER,
    p_PhuCap IN NUMBER
) AS
BEGIN
    UPDATE Luong
    SET LuongCoBan = p_LuongCoBan, PhuCap = p_PhuCap
    WHERE maNV = p_maNV;
END;


EXEC UpdateLuongNhanVien 'NV01', 5000000, 1000000;




---SP8:”C?p nh?t thông tin lo?i phòng”
CREATE OR REPLACE PROCEDURE UpdateLoaiPhong(
    p_maLoaiPH IN CHAR,
    p_TenLoaiPH IN NVARCHAR2,
    p_SoKhachToiDa IN NUMBER
) AS
BEGIN
    UPDATE LoaiPhong
    SET TenLoaiPH = p_TenLoaiPH, SoKhachToiDa = p_SoKhachToiDa
    WHERE maLoaiPH = p_maLoaiPH;
END;


EXEC UpdateLoaiPhong 'LP01', N'Deluxe', 3;



